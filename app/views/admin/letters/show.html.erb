<h1 class="text-2xl font-semibold mb-6">Words for <%= @letter.character.upcase %></h1>

<div class="mb-8 rounded border border-gray-200 bg-white p-4">
  <h2 class="text-lg font-semibold mb-3">Letter Audio</h2>
  <% if @letter.sound.attached? %>
    <div class="mb-3">
      <audio controls src="<%= url_for(@letter.sound) %>" class="w-full"></audio>
    </div>
  <% end %>

  <%= form_with model: [ :admin, alphabet, @letter ], class: "space-y-4" do |form| %>
    <div>
      <%= form.label :sound, "Upload sound", class: "block text-sm font-medium text-gray-700" %>
      <%= form.file_field :sound, accept: "audio/*", class: "mt-1 block w-full text-sm text-gray-700", id: "letter-audio-input" %>
    </div>

    <div class="flex flex-wrap items-center gap-3">
      <button type="button" id="record-audio" class="inline-flex items-center rounded border border-gray-300 px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50">
        Record
      </button>
      <button type="button" id="stop-audio" class="inline-flex items-center rounded border border-gray-300 px-3 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50" disabled>
        Stop
      </button>
      <span id="recording-status" class="text-sm text-gray-500"></span>
    </div>

    <audio id="recording-preview" controls class="hidden w-full"></audio>

    <% if @letter.sound.attached? %>
      <label class="flex items-center gap-2 text-sm text-gray-700">
        <%= check_box_tag "letter[remove_sound]", "1", false %>
        <span>Remove current sound</span>
      </label>
    <% end %>

    <div>
      <%= form.submit "Save sound", class: "inline-flex items-center rounded bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800" %>
    </div>
  <% end %>
</div>

<table class="min-w-full divide-y divide-gray-200 border border-gray-200">
  <thead class="bg-gray-50">  
    <tr>
      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Word</th>
      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Image</th>
      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Color</th>
      <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
    </tr>
  </thead>
  <tbody class="divide-y divide-gray-200 bg-white">
    <% @words.each do |word| %>
      <tr>
        <td class="px-4 py-3 text-sm text-gray-900"><%= word.content %></td>
        <td class="px-4 py-3">
          <% if word.picture_attached? %>
            <%= image_tag word.picture, alt: word.content, class: "h-12 w-12 object-contain" %>
          <% else %>
            <span class="text-sm text-gray-400">—</span>
          <% end %>
        </td>
        <td class="px-4 py-3">
          <% if word.color.present? %>
            <% swatch = word.color %>
            <div
              class="h-4 w-4 rounded-full border border-black/10"
              style="background-color: <%= swatch.code %>;"
              title="<%= swatch.name %>"
            ></div>
          <% else %>
            <span class="text-sm text-gray-400">—</span>
          <% end %>
        </td>
        <td class="px-4 py-3 text-sm">
          <div class="flex gap-3">
            <%= link_to "Edit", edit_admin_alphabet_word_path(alphabet, word), class: "text-blue-600 hover:underline" %>
            <%= link_to "Delete", admin_alphabet_word_path(alphabet, word), data: { turbo_method: :delete, turbo_confirm: "Delete this word?" }, class: "text-red-600 hover:underline" %>
          </div>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<script>
  (() => {
    const recordButton = document.getElementById("record-audio");
    const stopButton = document.getElementById("stop-audio");
    const status = document.getElementById("recording-status");
    const preview = document.getElementById("recording-preview");
    const input = document.getElementById("letter-audio-input");
    if (!recordButton || !stopButton || !status || !preview || !input) return;

    let mediaRecorder = null;
    let chunks = [];
    let stream = null;

    recordButton.addEventListener("click", async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        status.textContent = "Recording is not supported in this browser.";
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.addEventListener("dataavailable", (event) => {
          if (event.data.size > 0) chunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
          const blob = new Blob(chunks, { type: mediaRecorder.mimeType || "audio/webm" });
          const file = new File([blob], "letter-sound.webm", { type: blob.type });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          input.files = dataTransfer.files;
          preview.src = URL.createObjectURL(blob);
          preview.classList.remove("hidden");
          status.textContent = "Recording ready to save.";

          if (stream) {
            stream.getTracks().forEach((track) => track.stop());
            stream = null;
          }
        });

        mediaRecorder.start();
        recordButton.disabled = true;
        stopButton.disabled = false;
        status.textContent = "Recording...";
      } catch (error) {
        status.textContent = "Microphone access was denied.";
      }
    });

    stopButton.addEventListener("click", () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      recordButton.disabled = false;
      stopButton.disabled = true;
    });
  })();
</script>
